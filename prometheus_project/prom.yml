---
- name: Automating deployment of Prometheus on EC2
  hosts: localhost
  #connection: local
  gather_facts: False
  tasks:  
    - name: Launch EC2 Ubuntu Instanceinstance
      ec2:
          key_name: key2110
          group: launch-wizard-10 #sg name
          instance_type: t2.micro
          image: ami-0dba2cb6798deb6d8 #Ubuntu
          wait: true
          region: us-east-1
          # aws_access_key: “{{ lookup(‘env’, ‘AWS_ACCESS_KEY’) }}”
          # aws_secret_key: “{{ lookup(‘env’, ‘AWS_SECRET_KEY’) }}”
      register: ec2
    - name: Print all ec2 variables
      debug:
          var: ec2
    - name: Get the Ip address
      debug:
          var: ec2.instances[0].public_dns_name
    - name: add host to group ‘just_created’ with variable foo=42
      add_host:
        name: “{{ ec2.instances[0].public_dns_name }}”
        groups: ec2_hosts
        ansible_host: “{{ ec2.instances[0].public_dns_name }}”
        ansible_ssh_user: ubuntu # as per AMI
        ansible_ssh_private_key_file: /vagrant_data/key2110.pem
    - name: Wait for a while
      pause: seconds=60  

- name: Install servers into ec2 hosts
  hosts: ec2_hosts 
  become: True 
  tasks:
    - name: Installing nginx...
      apt:
        name: nginx
        state: present
        update_cache: yes 
########################################  
    - name: add user prometheus 
      user:
        name: prometheus
        shell: /bin/false
        create_home: no
    - name: add user node_exporter
      user:
        name: node_exporter
        shell: /bin/false
        create_home: no 
################################################
    - name: making prometheus dir under /etc
      file:
        path : /etc/prometheus
        state: directory
        owner: prometheus
        group: prometheus
    - name: making prometheus dir under /var/lib
      file:
        path : /var/lib/prometheus
        state: directory
        owner: prometheus
        group: prometheus 

##################################################    
    - name: Unarchive a prometheus-2.22.0.linux-amd64 to be downloaded
      unarchive:
        src: https://github.com/prometheus/prometheus/releases/download/v2.22.0/prometheus-2.22.0.linux-amd64.tar.gz
        dest: /home/ubuntu
        remote_src: yes 
        
##################################################
    - name: copying prometheus-2.22.0.linux-amd64/prometheus to /usr/local/bin/ with 755 permissions
      copy:
        src: /home/ubuntu/prometheus-2.22.0.linux-amd64/prometheus
        dest: /usr/local/bin/
        owner: prometheus
        group: prometheus
        remote_src: yes
        mode: '0755'
    - name: copying prometheus-2.22.0.linux-amd64/promtool to /usr/local/bin/ with 755 permissions
      copy:
        src: /home/ubuntu/prometheus-2.22.0.linux-amd64/promtool
        dest: /usr/local/bin/
        owner: prometheus
        group: prometheus
        remote_src: yes
        mode: '0755'
################################################
    - name: copying prometheus-2.22.0.linux-amd64/consoles to /etc/prometheus with 755 permissions
      copy:
        src: /home/ubuntu/prometheus-2.22.0.linux-amd64/consoles 
        dest: /etc/prometheus
        owner: prometheus
        group: prometheus
        remote_src: yes
        mode: '0755'
    - name: copying prometheus-2.22.0.linux-amd64/console_libraries to /etc/prometheus with 755 permissions
      copy:
        src: /home/ubuntu/prometheus-2.22.0.linux-amd64/console_libraries
        dest: /etc/prometheus
        owner: prometheus
        group: prometheus
        remote_src: yes
        mode: '0755'
    - name: Recursively remove directory
      file:
        path: /home/ubuntuprometheus-2.22.0.linux-amd64.tar.gz
        state: absent
    - name: Recursively remove directory
      file:
        path: /home/ubuntu/prometheus-2.22.0.linux-amd64
        state: absent    
  ###################################################
    - name: creating empty folder for git
      file:
        path : /home/ubuntu/Prometheus_Grafana
        state: directory
        owner: prometheus
        group: prometheus
    - name: git repo
      git:
        repo: https://github.com/Gaurav07Patel/prometheus.git
        clone: yes
        dest: /home/ubuntu/Prometheus_Grafana
    - name: copying prometheus.yml to destination
      copy:  
        src: /home/ubuntu/prometheus/prometheus_project/roles/prometheus/files/prometheus.yml
        dest: /etc/prometheus/
        owner: prometheus
        group: prometheus
        remote_src: yes
        mode: ‘0755’

    - name: copying prometheues.service to destination
      copy:
        src: /home/ubuntu/Prometheus_Grafana/ansible-prometheus/roles/prometheus/files/prometheus.service
        dest: /etc/systemd/system/
        owner: prometheus
        group: prometheus
        remote_src: yes
        mode: ‘0755’

    - name: reload daemon and making sure prometheus service is running
      systemd:
        state: started
        name: prometheus
        daemon_reload: yes
        enabled: yes

    - name: add user node_exporter
      user:
        name: node_exporter
        shell: /bin/false
        create_home: no
    - name: unarchieve node_exporter-1.0.1.linux-amd64.tar.gz
      unarchive:
        src: https://github.com/prometheus/node_exporter/releases/download/v1.0.1/node_exporter-1.0.1.linux-amd64.tar.gz
        dest: /home/ubuntu
        remote_src: yes
    - name: copying node_exporter to destination
      copy:
        src: /home/ubuntu/node_exporter-1.0.1.linux-amd64/node_exporter
        dest: /usr/local/bin
        owner: node_exporter
        group: node_exporter
        remote_src: yes
        mode: ‘0755’
    - name: recursively remove directory
      file:
        path: /home/ubuntu/node_exporter-1.0.1.linux-amd64.tar.gz
        state: absent
    - name: recursively remove directory
      file:
        path: /home/ubuntu/node_exporter-1.0.1.linux-amd64
        state: absent
    - name: copying node_exporter.service to destination
      copy:
        src: /home/ubuntu/Prometheus_Grafana/ansible-prometheus/roles/node_exporter/files/node_exporter.service
        dest: /etc/systemd/system/
        owner: node_exporter
        group: node_exporter
        remote_src: yes
        mode: ‘0755’
    - name: reload daemon and making sure node_exporter service is running
      systemd:
        state: started
        name: node_exporter
        daemon_reload: yes
        enabled: yes
    - name: copying prometheus.yml with node_exporter config to destination
      copy:
        src: /home/ubuntu/Prometheus_Grafana/ansible-prometheus/roles/node_exporter/files/prometheus_ne.yml
        dest: /etc/prometheus/
        owner: prometheus
        group: prometheus
        remote_src: yes
        mode: ‘0755’
    - name: reload daemon and making sure node_exporter service is running
      systemd:
        state: restarted
        name: node_exporter
# grafana
    - name: installing adduser, libfontconfig1 packages
      apt:
        pkg:
        - adduser
        - libfontconfig1
    - name: Install grafana.deb package
      apt:
        deb: https://dl.grafana.com/oss/release/grafana_7.2.2_amd64.deb
    - name: reload daemon and making sure grafana-server service is running
      systemd:
        state: started
        name: grafana-server.service
        daemon_reload: yes
        enabled: yes    
          
